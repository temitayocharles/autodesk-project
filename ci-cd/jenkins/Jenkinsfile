pipeline {
    agent any
    
    environment {
        DOCKER_REGISTRY = 'localhost:5000'
        DOCKER_CREDENTIALS_ID = 'docker-registry-credentials'
        KUBECONFIG_CREDENTIALS_ID = 'kubeconfig'
        AWS_CREDENTIALS_ID = 'aws-credentials'
    }
    
    stages {
        stage('Checkout') {
            steps {
                checkout scm
                script {
                    env.GIT_COMMIT_SHORT = sh(
                        script: "git rev-parse --short HEAD",
                        returnStdout: true
                    ).trim()
                    env.BUILD_TAG = "${env.BUILD_NUMBER}-${env.GIT_COMMIT_SHORT}"
                }
            }
        }
        
        stage('Environment Info') {
            steps {
                sh '''
                    echo "Build Number: ${BUILD_NUMBER}"
                    echo "Git Commit: ${GIT_COMMIT_SHORT}"
                    echo "Build Tag: ${BUILD_TAG}"
                    docker --version
                    kubectl version --client
                '''
            }
        }
        
        stage('Test - Data Ingestion Service') {
            steps {
                dir('services/data-ingestion-service') {
                    sh '''
                        python3 -m venv venv
                        . venv/bin/activate
                        pip install -r requirements.txt
                        pip install pytest pytest-cov
                        # pytest tests/ --cov=app --cov-report=xml
                        echo "Tests passed (placeholder)"
                    '''
                }
            }
        }
        
        stage('Test - Data Processing Service') {
            steps {
                dir('services/data-processing-service') {
                    sh '''
                        go test -v ./...
                        go test -race ./...
                        echo "Tests passed"
                    '''
                }
            }
        }
        
        stage('Test - Data API Service') {
            steps {
                dir('services/data-api-service') {
                    sh '''
                        python3 -m venv venv
                        . venv/bin/activate
                        pip install -r requirements.txt
                        pip install pytest pytest-cov
                        # pytest tests/ --cov=app --cov-report=xml
                        echo "Tests passed (placeholder)"
                    '''
                }
            }
        }
        
        stage('Security Scan') {
            parallel {
                stage('Scan Python Dependencies') {
                    steps {
                        sh '''
                            pip install safety
                            safety check || echo "Security vulnerabilities found"
                        '''
                    }
                }
                stage('Scan Go Dependencies') {
                    steps {
                        dir('services/data-processing-service') {
                            sh '''
                                go list -json -m all | nancy sleuth || echo "Vulnerabilities found"
                            '''
                        }
                    }
                }
            }
        }
        
        stage('Build Docker Images') {
            parallel {
                stage('Build Data Ingestion Service') {
                    steps {
                        dir('services/data-ingestion-service') {
                            sh """
                                docker build -t data-ingestion-service:${BUILD_TAG} .
                                docker tag data-ingestion-service:${BUILD_TAG} data-ingestion-service:latest
                            """
                        }
                    }
                }
                stage('Build Data Processing Service') {
                    steps {
                        dir('services/data-processing-service') {
                            sh """
                                docker build -t data-processing-service:${BUILD_TAG} .
                                docker tag data-processing-service:${BUILD_TAG} data-processing-service:latest
                            """
                        }
                    }
                }
                stage('Build Data API Service') {
                    steps {
                        dir('services/data-api-service') {
                            sh """
                                docker build -t data-api-service:${BUILD_TAG} .
                                docker tag data-api-service:${BUILD_TAG} data-api-service:latest
                            """
                        }
                    }
                }
            }
        }
        
        stage('Container Security Scan') {
            steps {
                sh '''
                    # Install Trivy if not present
                    which trivy || brew install trivy
                    
                    # Scan images
                    trivy image --severity HIGH,CRITICAL data-ingestion-service:latest
                    trivy image --severity HIGH,CRITICAL data-processing-service:latest
                    trivy image --severity HIGH,CRITICAL data-api-service:latest
                '''
            }
        }
        
        stage('Push to Registry') {
            when {
                branch 'main'
            }
            steps {
                script {
                    docker.withRegistry("http://${DOCKER_REGISTRY}", DOCKER_CREDENTIALS_ID) {
                        sh """
                            docker tag data-ingestion-service:${BUILD_TAG} ${DOCKER_REGISTRY}/data-ingestion-service:${BUILD_TAG}
                            docker push ${DOCKER_REGISTRY}/data-ingestion-service:${BUILD_TAG}
                            
                            docker tag data-processing-service:${BUILD_TAG} ${DOCKER_REGISTRY}/data-processing-service:${BUILD_TAG}
                            docker push ${DOCKER_REGISTRY}/data-processing-service:${BUILD_TAG}
                            
                            docker tag data-api-service:${BUILD_TAG} ${DOCKER_REGISTRY}/data-api-service:${BUILD_TAG}
                            docker push ${DOCKER_REGISTRY}/data-api-service:${BUILD_TAG}
                        """
                    }
                }
            }
        }
        
        stage('Deploy to Kubernetes') {
            when {
                branch 'main'
            }
            steps {
                script {
                    withCredentials([file(credentialsId: KUBECONFIG_CREDENTIALS_ID, variable: 'KUBECONFIG')]) {
                        sh '''
                            # Update image tags in Kubernetes manifests
                            sed -i '' "s|image: data-ingestion-service:.*|image: ${DOCKER_REGISTRY}/data-ingestion-service:${BUILD_TAG}|g" kubernetes/manifests/data-ingestion-deployment.yaml
                            sed -i '' "s|image: data-processing-service:.*|image: ${DOCKER_REGISTRY}/data-processing-service:${BUILD_TAG}|g" kubernetes/manifests/data-processing-deployment.yaml
                            sed -i '' "s|image: data-api-service:.*|image: ${DOCKER_REGISTRY}/data-api-service:${BUILD_TAG}|g" kubernetes/manifests/data-api-deployment.yaml
                            
                            # Apply Kubernetes manifests
                            kubectl apply -f kubernetes/manifests/ --namespace=aec-data
                            
                            # Wait for rollout
                            kubectl rollout status deployment/data-ingestion-service -n aec-data --timeout=5m
                            kubectl rollout status deployment/data-processing-service -n aec-data --timeout=5m
                            kubectl rollout status deployment/data-api-service -n aec-data --timeout=5m
                        '''
                    }
                }
            }
        }
        
        stage('Smoke Tests') {
            when {
                branch 'main'
            }
            steps {
                sh '''
                    # Wait for services to be ready
                    sleep 30
                    
                    # Test health endpoints
                    kubectl port-forward -n aec-data svc/data-ingestion-service 8000:8000 &
                    PF_PID=$!
                    sleep 5
                    
                    curl -f http://localhost:8000/health || exit 1
                    
                    kill $PF_PID
                    
                    echo "Smoke tests passed"
                '''
            }
        }
    }
    
    post {
        always {
            cleanWs()
        }
        success {
            echo 'Pipeline succeeded!'
            // Send notification (Slack, email, etc.)
        }
        failure {
            echo 'Pipeline failed!'
            // Send alert
        }
    }
}
