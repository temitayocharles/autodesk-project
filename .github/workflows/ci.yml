name: CI

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]
  workflow_dispatch:

jobs:
  test-python:
    strategy:
      fail-fast: false
      matrix:
        svc:
          - name: data-api-service
            dir: services/data-api-service
          - name: data-ingestion-service
            dir: services/data-ingestion-service
    uses: temitayocharles/shared-workflows/.github/workflows/tests-python.yml@main
    with:
      python-version: "3.11"
      working-directory: ${{ matrix.svc.dir }}
      requirements-file: requirements.txt
      test-cmd: PYTHONPATH=. pytest -q

  test-go:
    uses: temitayocharles/shared-workflows/.github/workflows/tests-go.yml@main
    with:
      go-version: "1.21"
      working-directory: services/data-processing-service
      test-cmd: go test -v ./...

  build-push:
    needs: [test-python, test-go]
    if: github.event_name == 'workflow_dispatch'
    permissions:
      contents: read
      packages: write
    strategy:
      fail-fast: false
      matrix:
        svc:
          - name: autodesk-data-api-service
            context: services/data-api-service
            dockerfile: services/data-api-service/Dockerfile
          - name: autodesk-data-ingestion-service
            context: services/data-ingestion-service
            dockerfile: services/data-ingestion-service/Dockerfile
          - name: autodesk-data-processing-service
            context: services/data-processing-service
            dockerfile: services/data-processing-service/Dockerfile
    uses: temitayocharles/shared-workflows/.github/workflows/docker-build-push.yml@main
    with:
      registry: ghcr.io
      image_name: ghcr.io/temitayocharles/${{ matrix.svc.name }}
      context: ${{ matrix.svc.context }}
      dockerfile: ${{ matrix.svc.dockerfile }}
      tags: staging-${{ github.sha }}
    secrets:
      registry_username: ${{ github.actor }}
      registry_password: ${{ secrets.GITHUB_TOKEN }}

